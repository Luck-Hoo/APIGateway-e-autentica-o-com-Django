{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Consulta Contratações - Gateway API</title>

    <link
      rel="icon"
      href="{% static 'home/img/GovDigital.ico' %}"
      type="image/x-icon"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --body-bg: #f4f6f9;
        --body-color: #212529;
        --navbar-bg: #ffffff;
        --card-bg: #ffffff;
        --card-color: #212529;
        --footer-bg: #ffffff;
        --footer-color: #6c757d;
        --hero-bg-gradient: linear-gradient(135deg, #0d6efd, #0a58ca);
        --text-muted-color: #6c757d;
      }

      body.dark-mode {
        --body-bg: #121212;
        --body-color: #e0e0e0;
        --navbar-bg: #1f1f1f;
        --card-bg: #1e1e1e;
        --card-color: #e0e0e0;
        --footer-bg: #1f1f1f;
        --footer-color: #ccc;
        --hero-bg-gradient: linear-gradient(135deg, #343a40, #212529);
        --text-muted-color: #b0b0b0;
      }

      body {
        background-color: var(--body-bg);
        color: var(--body-color);
        font-family: "Segoe UI", sans-serif;
        transition: background-color 0.3s, color 0.3s;
      }

      body.dark-mode {
        background-color: var(--body-bg);
        color: var(--body-color);
      }

      body.dark-mode .form-control,
      body.dark-mode .form-select {
        background-color: #2b2b2b;
        color: #e0e0e0;
        border-color: #444;
      }

      .navbar {
        background-color: var(--navbar-bg);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        transition: background-color 0.3s;
      }

      .hero-section {
        background: var(--hero-bg-gradient);
        color: white;
        padding: 70px 20px;
        border-radius: 12px;
        text-align: center;
        margin-top: 30px;
        margin-bottom: 50px;
        transition: background 0.3s;
      }

      .card {
        transition: all 0.25s ease-in-out, background-color 0.3s, color 0.3s;
        border: none;
        border-radius: 12px;
        background-color: var(--card-bg);
        color: var(--card-color);
      }

      footer {
        margin-top: 60px;
        padding: 20px 0;
        background-color: var(--footer-bg);
        border-top: 1px solid #e5e5e5;
        text-align: center;
        color: var(--footer-color);
        transition: background-color 0.3s, color 0.3s;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .spin {
        animation: spin 1s linear infinite;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
      <div class="container">
        <a
          class="navbar-brand fw-bold text-primary"
          href="{% url 'home:home' %}"
        >
          <i class="bi bi-diagram-3"></i> Gateway API
        </a>

        <div class="d-flex align-items-center">
          <button
            id="darkModeToggle"
            class="btn btn-outline-secondary btn-sm me-3"
          >
            <i class="bi bi-moon-stars"></i> Escuro
          </button>

          {% if user.is_authenticated %}
          <span class="me-3 mt-2 text-muted">Olá, {{ user.username }}</span>
          <a
            href="{% url 'logout:logout' %}"
            class="btn btn-outline-danger btn-sm"
            >Sair</a
          >
          {% else %}
          <a href="{% url 'login:login' %}" class="btn btn-primary btn-sm"
            >Login</a
          >
          {% endif %}
        </div>
      </div>
    </nav>

    <div class="container py-5" style="margin-top: 90px">
      <div class="hero-section shadow-sm">
        <h1 class="display-5 fw-bold">Consulta de Contratações (PNCP)</h1>
        <p class="lead mt-3">
          Busque contratos públicos usando filtros de Unidade Gestora e período.
        </p>
      </div>

      <div class="row justify-content-center mb-4 g-3">
        <div class="col-md-3">
          <label for="unidadeGestora-input" class="form-label text-muted"
            >Unidade Gestora (código ou nome)</label
          >
          <input
            id="unidadeGestora-input"
            type="text"
            class="form-control"
            placeholder="Ex: 260001 (Opcional)"
          />
        </div>
        <div class="col-md-3">
          <label for="codigoModalidade-input" class="form-label text-muted"
            >Modalidade (Código)</label
          >
          <input
            id="codigoModalidade-input"
            type="number"
            class="form-control"
            placeholder="Ex: 5 (Obrigatório)"
            required
          />
        </div>
        <div class="col-md-3">
          <label for="tamanhoPagina-select" class="form-label text-muted"
            >Tamanho da Página</label
          >
          <select id="tamanhoPagina-select" class="form-select">
            <option value="10" selected>10 registros</option>
            <option value="20">20 registros</option>
            <option value="50">50 registros</option>
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button id="search-btn" class="btn btn-primary w-100">
            <i class="bi bi-search"></i> Consultar
          </button>
        </div>
      </div>
      <div class="row justify-content-center mb-4 g-3">
        <div class="col-md-6">
          <label for="dataInicial-input" class="form-label text-muted"
            >Data Inicial (YYYY-MM-DD)</label
          >
          <input
            id="dataInicial-input"
            type="date"
            class="form-control"
            value=""
            required
          />
        </div>
        <div class="col-md-6">
          <label for="dataFinal-input" class="form-label text-muted"
            >Data Final (YYYY-MM-DD)</label
          >
          <input
            id="dataFinal-input"
            type="date"
            class="form-control"
            value=""
            required
          />
        </div>
      </div>

      <div id="status-message" class="text-center my-3 text-muted"></div>

      <div id="contratacoes-data-table" style="display: none">
        <h3 class="mb-3 text-primary">Contratos Encontrados</h3>
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead class="table-primary">
              <tr>
                <th>Núm Compra</th>
                <th>Fornecedor</th>
                <th>Modalidade</th>
                <th>Processo</th>
                <th>Núm Parcelas</th>
                <th>Valor Parcelas (R$)</th>
                <th>Valor Global (R$)</th>
                <th>Vigência Inicial</th>
                <th>Vigência Final</th>
              </tr>
            </thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>
        <div class="text-end mt-3">
          <button
            id="load-more-btn"
            class="btn btn-outline-primary"
            style="display: none"
          >
            Carregar Mais...
          </button>
        </div>
      </div>
    </div>

    <footer>
      <div class="container">
        <p>
          &copy; {{ now|date:"Y" }} Gateway de Dados Abertos — Desenvolvido com
          Django
        </p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // Variáveis DOM
      const statusMessageDiv = document.getElementById("status-message");
      const tableDiv = document.getElementById("contratacoes-data-table");
      const tableBody = document.getElementById("table-body");
      const searchButton = document.getElementById("search-btn");
      const loadMoreButton = document.getElementById("load-more-btn");
      const unidadeGestoraInput = document.getElementById(
        "unidadeGestora-input"
      );
      const codigoModalidadeInput = document.getElementById("codigoModalidade-input")
      const dataInicialInput = document.getElementById("dataInicial-input");
      const dataFinalInput = document.getElementById("dataFinal-input");

      const tamanhoPaginaSelect = document.getElementById("tamanhoPagina-select");
      // Estado da Pesquisa
      let currentPage = 1;
      let currentParams = {};
      const CONTRATACOES_ENDPOINT_KEY = "consultar_contratacoes";

      // --- FUNÇÕES DE API E AUXILIARES ---

      // Modo escuro
      const toggleButton = document.getElementById("darkModeToggle");
      toggleButton.addEventListener("click", () => {
        document.body.classList.toggle("dark-mode");
        const icon = toggleButton.querySelector("i");
        if (document.body.classList.contains("dark-mode")) {
          icon.className = "bi bi-sun";
          toggleButton.innerHTML = '<i class="bi bi-sun"></i> Claro';
        } else {
          icon.className = "bi bi-moon-stars";
          toggleButton.innerHTML = '<i class="bi bi-moon-stars"></i> Escuro';
        }
      });

      /**
       * Função genérica para chamar o endpoint de Contratações.
       */
      async function fetchContratacoes(params, page = 1) {
        const query = new URLSearchParams({
          ...params,
          pagina: page,
        }).toString();
        const url = `/gateway/contratacoes/${CONTRATACOES_ENDPOINT_KEY}/?${query}`;

        const res = await fetch(url);

        if (!res.ok) {
          try {
            const errorData = await res.json();
            const errorMessage = errorData.error || `Erro HTTP ${res.status}`;
            throw new Error(errorMessage);
          } catch {
            throw new Error(`Falha ao conectar/HTTP ${res.status}`);
          }
        }

        const data = await res.json();
        // Assume que o objeto de resposta contém 'resultado' e 'pagination'
        return data;
      }

      // Função para formatar números como moeda
      const formatter = new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: "BRL",
        minimumFractionDigits: 2,
      });

      // --- LÓGICA DE PESQUISA ---

      async function performSearch(page = 1) {
        // Desabilitar botões e mostrar spinner
        searchButton.disabled = true;
        loadMoreButton.disabled = true;
        loadMoreButton.style.display = "none";

        if (page === 1) {
          tableBody.innerHTML = "";
          tableDiv.style.display = "none";
          currentParams = {
            dataInicial: dataInicialInput.value,
            dataFinal: dataFinalInput.value,
            unidadeGestora: unidadeGestoraInput.value,
            codigoModalidade: codigoModalidadeInput.value, // <--- Coletando modalidade
            tamanhoPagina: tamanhoPaginaSelect.value,
          };
          // Remover campos vazios
          Object.keys(currentParams).forEach(
            (key) => currentParams[key] === "" && delete currentParams[key]
          );

          // Validação (Incluindo a Modalidade)
          if (
            !currentParams.dataInicial ||
            !currentParams.dataFinal ||
            !currentParams.codigoModalidade
          ) {
            statusMessageDiv.innerHTML =
              '<p class="text-danger">As datas Inicial, Final e o Código da Modalidade são obrigatórios.</p>';
            searchButton.disabled = false;
            return;
          }
        }

        statusMessageDiv.innerHTML = `<p class="text-info"><i class="bi bi-arrow-clockwise spin"></i> Carregando página ${page}...</p>`;

        try {
          const data = await fetchContratacoes(currentParams, page);
          const contratos = data.resultado || []; // Lista de contratos
          const totalPages = data.pagination
            ? data.pagination.totalPages
            : page; // Total de páginas (ou a página atual se não houver paginação info)

          if (contratos.length === 0 && page === 1) {
            statusMessageDiv.innerHTML =
              '<p class="text-warning">Nenhum contrato encontrado com os filtros fornecidos.</p>';
            tableDiv.style.display = "none";
            return;
          }

          renderTable(contratos);

          // Lógica de Paginação
          currentPage = page;
          if (currentPage < totalPages) {
            loadMoreButton.style.display = "block";
            loadMoreButton.disabled = false;
            loadMoreButton.textContent = `Carregar Mais (Página ${
              currentPage + 1
            } de ${totalPages})`;
          } else {
            loadMoreButton.style.display = "none";
            statusMessageDiv.innerHTML =
              '<p class="text-success">Todos os dados foram carregados.</p>';
          }

          if (page === 1) {
            statusMessageDiv.innerHTML =
              '<p class="text-success">Dados consultados com sucesso!</p>';
            tableDiv.style.display = "block";
          }
        } catch (err) {
          statusMessageDiv.innerHTML = `<p class="text-danger">Falha ao buscar Contratos: ${err.message}</p>`;
          console.error("Erro de consulta:", err);
          tableDiv.style.display = "none";
        } finally {
          searchButton.disabled = false;
          if (loadMoreButton.style.display === "block") {
            loadMoreButton.disabled = false;
          }
        }
      }

      // --- FUNÇÃO DE RENDERIZAÇÃO DA TABELA ---

      function renderTable(contratos) {
        if (contratos.length === 0) return;

        contratos.forEach((contrato) => {
          const newRow = tableBody.insertRow();

          // Valores a serem exibidos (usando '??' para fallback para string vazia)
          const numCompra = contrato.numeroCompra ?? "";
          const fornecedor = contrato.nomeFornecedor ?? "";
          const modalidade = contrato.modalidadeLicitacao ?? "";
          const processo = contrato.numeroProcesso ?? "";
          const numParcelas = contrato.numeroParcelas ?? 0;
          const valorParcelas = formatter.format(contrato.valorParcelas || 0);
          const valorGlobal = formatter.format(contrato.valorGlobal || 0);
          const vigenciaInicial = contrato.dataVigenciaInicial
            ? new Date(contrato.dataVigenciaInicial).toLocaleDateString("pt-BR")
            : "";
          const vigenciaFinal = contrato.dataVigenciaFinal
            ? new Date(contrato.dataVigenciaFinal).toLocaleDateString("pt-BR")
            : "";

          newRow.innerHTML = `
                  <td>${numCompra}</td>
                  <td>${fornecedor}</td>
                  <td>${modalidade}</td>
                  <td>${processo}</td>
                  <td>${numParcelas}</td>
                  <td>${valorParcelas}</td>
                  <td>${valorGlobal}</td>
                  <td>${vigenciaInicial}</td>
                  <td>${vigenciaFinal}</td>
              `;
        });

        tableDiv.style.display = "block";
      }

      // --- EVENT LISTENERS ---

      searchButton.addEventListener("click", () => performSearch(1));

      loadMoreButton.addEventListener("click", () =>
        performSearch(currentPage + 1)
      );

      // Carregamento inicial (apenas garantindo que o botão load more esteja escondido)
      window.addEventListener("load", () => {
        loadMoreButton.style.display = "none";
      });
    </script>
  </body>
</html>
